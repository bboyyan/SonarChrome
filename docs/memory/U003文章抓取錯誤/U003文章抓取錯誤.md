# U003: 文章抓取錯誤

## 問題描述
AI 助手在抓取 Threads 貼文內容時出現以下問題：
1. **抓到不相關的內容**：例如股票代碼（`[BABA +1.67%]`）、按讚數（`24 2`）、使用者帳號（`u_tingya`）等與文章主體無關的資訊
2. **切換貼文時內容卡住**：點擊第二篇貼文的 ✨ 按鈕後，「當前文脈」區塊仍然顯示第一篇貼文的內容，沒有正確更新

## 發生時間
2025-12-23

## 根本原因

### 問題 1：抓到不相關內容
**原因：選取器（Selector）太過寬鬆，把整個貼文容器內的所有文字都抓進來了。**

Threads 的貼文結構包含很多元素：
```
貼文容器
├── 使用者資訊（帳號、簡介）
├── 文章主體 ← 我們要的
├── 標籤（Hashtags）
├── 互動數據（按讚數、留言數）
└── 操作按鈕
```

程式使用 `[dir="auto"]` 這個屬性來抓取文字，但這個屬性在 Threads 中**到處都有**，導致連使用者簡介、互動數據都被抓進來。

### 問題 2：切換貼文時內容卡住
**原因：程式「太聰明」，試圖自動找出貼文之間的回覆關係，但在動態牆（Feed）誤判了。**

程式有兩種抓取策略：
- **策略 A（詳細頁）**：當你點開某篇貼文的詳細頁面時，抓取「主文」和「你要回覆的留言」
- **策略 B（動態牆）**：在首頁動態牆時，試圖找出「這篇貼文是不是在回覆上面某篇」

問題出在**策略 B**：在動態牆中，每篇貼文都是獨立的，但程式會誤以為「第二篇貼文是在回覆第一篇」，所以一直把第一篇當作「主文」顯示。

## 為什麼會發生
1. **Threads 的 HTML 結構很複雜**：Meta（Facebook）的網頁為了效能和安全性，會把很多資訊混在一起，沒有明確的「這是文章主體」標記
2. **過度設計的智慧功能**：為了在詳細頁提供更好的上下文（讓 AI 知道你在回覆哪篇），加入了自動尋找「主文」的功能，但在動態牆反而造成誤判

## 解決方法

### 解法 1：加強內容過濾器
在抓取文字時，加入更嚴格的過濾規則，排除以下內容：

✅ **已過濾的內容**：
- 股票代碼：`[BABA +1.67%]`、`$BTC`
- 純數字行：`24 2`（按讚數、留言數）
- 裸露帳號：`u_tingya`（沒有其他文字的帳號名稱）
- 時間戳記：`12小時`、`3m`、`5d`
- UI 標籤：`翻譯年糕`、`Translate`

### 解法 2：停用動態牆的「智慧上下文」功能
**暫時關閉策略 B**，只在詳細頁（點開貼文後）才啟用上下文抓取。

這樣做的好處：
- ✅ 每篇貼文都是獨立抓取，不會互相干擾
- ✅ 避免誤判回覆關係
- ⚠️ 缺點：在動態牆回覆留言時，AI 看不到「主文」（但實務上影響不大，因為使用者通常會點開詳細頁再回覆）

## 驗證方法
1. 重新載入擴充功能
2. 在 Threads 首頁動態牆，點擊第一篇貼文的 ✨ 按鈕
3. 檢查「當前文脈」區塊，確認：
   - ✅ 沒有出現按讚數（如 `24 2`）
   - ✅ 沒有出現股票代碼（如 `[BABA +1.67%]`）
   - ✅ 沒有出現裸露帳號（如 `u_tingya`）
4. 點擊第二篇貼文的 ✨ 按鈕
5. 確認「當前文脈」區塊**正確更新為第二篇貼文的內容**

## 關於 Hashtags（標籤）
**建議保留標籤在抓取內容中**，原因：
- ✅ 標籤通常是文章主題的關鍵字（如 `#股票`、`#心情`）
- ✅ AI 模型能正確理解標籤的意義，不會誤判
- ✅ 有助於 AI 判斷文章的領域和語氣

除非發現標籤造成明顯的誤判，否則建議保留。

## 預防措施
1. **定期檢查 Threads 的 HTML 結構變化**：Meta 可能會更新網頁結構，導致選取器失效
2. **收集使用者回報**：建立回報機制，讓使用者能快速反應抓取錯誤
3. **考慮使用 Threads API**：如果 Meta 未來開放官方 API，可以改用 API 抓取，避免 HTML 結構變化的問題

## 技術細節（給工程師）
- 修改檔案：`src/content.ts`
- 關鍵函式：`extractPostText()`, `extractFullContext()`
- 變更內容：
  1. 新增 Regex 過濾器：`/\[[A-Z]{2,6}\s*[+\-]?\d+(\.\d+)?%\]/`（股票）、`/^[\d\s,.]+$/`（純數字）、`/^u_[a-zA-Z0-9_.]+$/`（帳號）
  2. 註解掉 Strategy B（Feed View Sibling Grouping）邏輯

## 相關資源
- [Threads 網頁版](https://www.threads.net/)
- [Chrome DevTools 教學](https://developer.chrome.com/docs/devtools/)

## 標籤
`#content-extraction` `#threads` `#bug-fix` `#context-detection`
